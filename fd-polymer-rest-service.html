<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../core-ajax/core-ajax.html">
<<<<<<< HEAD
<link rel="import" href="../core-localstorage/core-localstorage.html">
=======
<link rel="import" href="../fd-polymer-api-settings/fd-polymer-api-settings.html">
>>>>>>> Split into rest and settings

<!--
Element providing a service for interfacing Freedomotic's Rest APIs.

##### Example

    <fd-rest-service 
      apiUrl="fritz.bestmazzo.it:9111/v3/"
      ssl="false" credentialRequired="true"
      fdtype="system/info/framework"
      method="GET"
      >
    </fd-rest-service>

@element fd-rest-service
@blurb Element providing a service for interacting with Freedomoric's Rest APIs.
@status beta
@homepage http://freedomotic.github.io/fd-polymer-rest-service
-->
<polymer-element name="fd-rest-service" attributes="forceurl fditems fdtype toast apiurl credentialrequired method auto params body contentType">
  <template>
    <template if="{{!forceUrl}}">
      <fd-api-settings apiUrl="{{apiUrl}}"></fd-api-settings>
    </template>
    <core-ajax id="ajax" 
      auto="{{auto}}"
      on-core-error="{{errorHandler}}"
      on-core-response="{{elementsLoaded}}"
      response="{{fditems}}"
      handleAs="json"
      method="{{method}}"
      params="{{params}}"
      body="{{body}}"
      contentType="{{contentType}}"
      withCredentials="{{credentialrequired}}">
    </core-ajax>

  </template>
  <script>
  Polymer('fd-rest-service', {
    alwaysPrepare: true,
      /**
       * The 'fdtype' attribute represents the path inside API tree
       *
       * @attribute fdtype
       * @type string
       */
    fdtype:'environments',

      /**
       * The 'fditems' attribute collects data received as a response from a API call.
       * Usually you link this attribute to a declared variable, using the "{{ }}" notation
       * 
       * @attribute fditems
       * @type array
       */
    fditems: [],
    
      /**
       * The 'method' attribute represents the HTTP method used for the current API call
       *
       * @attribute method
       * @type string
       */
    method: "GET",

      /**
       * The 'auto' attribute tells whether API call should be fired imediately or explicitely by the go() call
       *
       * @attribute auto
       * @type boolean
       */
    
    auto: true,
      /**
       * The 'credentialRequired' attribute tells whether the API call requires authentication 
       *
       * @attribute credentialRequired
       * @type boolean
       */
    
    credentialRequired: false,
      /**
       * The 'ssl' attribute tells whether the API call requires a encrypted connection 
       *
       * @attribute ssl
       * @type boolean
       */
    ssl: false,

      /**
       * The 'apiUrl' attribute represents the URL through which the service can reach the API 
       *
       * @attribute apiUrl
       * @type string
       */
    apiUrl: undefined,
    
      /**
       * The 'forceUrl' attribute forces the given apiUrl thus overriding fd-api-settings data 
       *
       * @attribute forceUrl
       * @type boolean
       */
    forceUrl: false,


    contentType: "application/json",

    observe: {
      "fdtype apiUrl": "reloadUrl"
    },
    
    created: function() {
      this.fditems = [];
    },

    reloadUrl: function(){
      if(!!this.apiurl && !!this.fdtype){   
        this.$.ajax.url = this.apiUrl + this.fdtype +"/";
        console.log("REST:" + this.apiUrl);
      }
    },

    autoChanged: function(){
      if(this.auto){
        this.$.ajax.auto =  this.auto;
      }
    },
    elementsLoaded: function(event) {
      console.log("Loaded " + this.fdtype + " data:", this.fditems);
      this.fire("rest-response", event)
    },
    
    errorHandler: function(event){
      console.log("Error:", event.detail);
      if(this.toast){
        this.toast.text="There was a problem loading "+this.fdtype+" data.";
        this.toast.show();
      }
      this.fire("rest-error", event)
    },

    go: function(){
      this.reloadUrl();
      this.$.ajax.go();
    }
    
  });
  </script>
</polymer-element>
